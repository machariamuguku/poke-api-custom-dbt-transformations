# Airbyte Custom Transformation With DBT

Either create a new dbt project from scratch or copy the project generated by airbyte's basic normalization.

## Using the Airbyte Generated DBT Project

- N/B: This only works on docker deployments since [on Kubernetes volumes are ephemeral](https://discuss.airbyte.io/t/how-to-get-dbt-transformations-on-a-k8s-deployed-airbyte-installation/2013/2)

- Create a new airbyte connection with basic normalization enabled (e.g from PokeAPI source to postgres destination)

- Run connection (synchronize)

- Identify workspace id of most recent synchronize

  - From connection status page, open latest successful job

  - Note down the folder that the process ran from the top section of the log.
  
  - Eg one shown below is `/tmp/workspace/5/0` with 5 corresponding to Airbyte `job_id`, and 0 to `attempt_id`

    ![airbyte workspace id](img/workspace_id.png)

- SSH into Airbyte server (ignore if running airbyte locally)

- Export workspace id to make working with commands easier

    ```bash
    NORMALIZE_WORKSPACE="5/0/"
    ```

- Verify project is configured correctly

  - Identify normalization container version

    ```bash
    docker images | grep normalization
    # eg 0.2.22
    ```

  - Verify (dbt debug)

    ```bash
    docker run --rm -i -v airbyte_workspace:/data -w /data/$NORMALIZE_WORKSPACE/normalize --network host --entrypoint /usr/local/bin/dbt airbyte/normalization:0.2.22 debug --profiles-dir=. --project-dir=.
    ```

- Export dbt normalization project to outside Airbyte

  - Identify the airbyte server container

    ```bash
    docker ps
    # e.g airbyte-server
    ```

  - Copy the normalize directory from the container to the current working directory

    ```bash
    docker cp airbyte-server:/tmp/workspace/$NORMALIZE_WORKSPACE/normalize .
    ```

  - Export project outside server for modification (jump host/tunnel if needed)

    ```bash
    scp -r ubuntu@airbyte-docker.onalabs.org:/home/ubuntu/normalize Desktop/normalize/
    ```

- Modify according to need

- Due to an issue outlined [here](https://github.com/airbytehq/airbyte/issues/5590), you must change `"packages-install-path: /dbt"` variable in `dbt_project.yml` file to `"packages-install-path: ../dbt"`
  - This is to persist external dbt project dependencies between multiple dbt command runs

  - N/B: An alternative solution is to run the `dbt deps` command locally (pull external dependencies) and commit them alongside project files

- Git ignore all files containing secrets (logs, destination_catalog.json, destination_config.json, profiles.yml, ssh.json, etc)

- Commit changes and push to github repository

- Add custom dbt transformations to Airbyte

  - Modify transformation settings for your connection to:

    - Switch Normalization to `Raw data (JSON)` from `Normalized tabular data`.

      - This is to ensure we run normalization using our custom dbt transformations.

        ![airbyte raw normalization](img/raw_normalization.png)

    - Add two custom transformations

      - dbt deps. This is to install external dependencies required by the dbt project.

         ![airbyte dbt deps](img/dbt_deps.png)

      - dbt run. To actually run the custom transformations

         ![airbyte dbt run](img/dbt_run.png)

      - N/B:
        - You can skip the first step if you commit dependencies with the project

        - The `Docker image URL with dbt installed` is the official dbt docker image by fishtown analytics

        - To use a private github repository, generate and use a Personal Access Token on the github repository url as:

          - `https://github_user:github_personal_token@github.com/github_user/name-of-repository.git`

          - e.g `https://machariamuguku:***********@github.com/machariamuguku/poke-api-custom-dbt-transformations.git`

        - To use a non default github branch, specify it on the git branch name field
